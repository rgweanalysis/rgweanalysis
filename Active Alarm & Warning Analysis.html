<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>مقارنة إنذارات التوربينات (CSV) — نسخة مُجمّعة</title>
  <style>
    :root{
      --bg:#f7f7fb;--card:#fff;--ink:#0f172a;--muted:#64748b;
      --brand:#2563eb;--brand-ink:#fff;--line:#e2e8f0;--ok:#059669;--warn:#d97706;--err:#b91c1c;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",Arial}
    header{position:sticky;top:0;background:var(--card);box-shadow:0 2px 12px rgba(2,6,23,.06);z-index:10}
    header .wrap,main .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{font-size:20px;margin:0}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:0 2px 12px rgba(2,6,23,.04)}
    .controls{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--brand);color:var(--brand-ink)}
    .btn.soft{background:#e5e7eb}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .field{display:block}
    .field label{font-size:13px;color:var(--muted)}
    .field select,.field input[type=file],.search{width:100%;border:1px solid var(--line);border-radius:12px;padding:10px 12px;font:inherit}
    .badger{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 10px;font-size:12px;color:var(--muted)}
    .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{border-collapse:collapse;min-width:720px;width:100%}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:right; vertical-align: top;}
    thead th{background:#f1f5f9;color:#334155;font-weight:600;cursor:pointer;user-select:none}
    tbody tr:hover{background:#f9fafb}
/* Highlight elements for alarms repeated across all three days */
/*
  We differentiate the row-level highlight (currently unused in JS) from the
  individual turbine badge highlight. The badge itself should be a strong
  red to call attention to turbines that repeat across all three days.
*/
/* row highlight – lightly tinted red; currently unused but kept for future */
.highlight-3days {
  background-color: #ffe6e6 !important;
}
/* turbine badge highlight – very light red background with black text and a clear black border
   These pills indicate alarms repeated across all three days. The light tone ensures
   readability while still drawing attention. */
.turbine-pill.highlight-3days {
  background-color: #ffd9d9 !important;
  border-color: #000 !important;
  color: #000 !important;
}
/* Hide the separate 3‑day repeated card; repeats are shown via highlighting */
#card-repeated-3days {
  display: none !important;
}
/* ضبط عرض الأعمدة في الجداول على الشاشة */
#tbl-repeated th:first-child, #tbl-repeated td:first-child,
#tbl-new th:first-child, #tbl-new td:first-child,
#tbl-cleared th:first-child, #tbl-cleared td:first-child{
  width:10%;
  white-space:nowrap;
}
#tbl-repeated th:nth-child(2), #tbl-repeated td:nth-child(2),
#tbl-new th:nth-child(2), #tbl-new td:nth-child(2),
#tbl-cleared th:nth-child(2), #tbl-cleared td:nth-child(2){
  width:55%;
}
#tbl-repeated th:nth-child(3), #tbl-repeated td:nth-child(3),
#tbl-new th:nth-child(3), #tbl-new td:nth-child(3),
#tbl-cleared th:nth-child(3), #tbl-cleared td:nth-child(3){
  width:35%;
}

    /* تعديل لعرض قائمة التوربينات بشكل أفضل */
        /* تنسيق كل توربينة كبادج منفصلة */
    td .turbine-list {
      max-height: 100px;
      overflow-y: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 13px;
      line-height: 1.4;
      background: #fff;
      border: 0;
      padding: 4px;
      border-radius: 6px;
    }
    td .turbine-list .turbine-pill {
      border: 1px solid #000;
      border-radius: 4px;
      padding: 2px 6px;
      background: #fff;
      white-space: nowrap;
      font-size: 12px;
      line-height: 1.4;
    }

    .note{font-size:13px;color:var(--muted)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .stack{display:flex;flex-direction:column;gap:8px}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .summary{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media(min-width:700px){.summary{grid-template-columns:repeat(4,minmax(0,1fr));}}
    .kpi{border:1px solid var(--line);border-radius:12px;padding:10px;text-align:center}
    .kpi .label{font-size:12px;color:var(--muted)} .kpi .value{font-size:24px;font-weight:700}
    #console{display:none;margin-top:10px;border:1px solid #fecaca;background:#fef2f2;border-radius:12px;padding:10px;color:#991b1b;font-size:14px}
    .file-box{display:grid;gap:10px}
  
    .lang-switch{
      display:flex;
      gap:4px;
    }
    .lang-switch .btn{
      padding:6px 10px;
      font-size:13px;
    }
    body.ltr{
      direction:ltr;
    }
    body.ltr .table-wrap th,
    body.ltr .table-wrap td{
      text-align:left;
    }

</style>
<style>

/* — تحسين عرض قائمة التوربينات: بدون سكرول أفقي + التفاف في أعمدة — */
.turbine-list{ display:flex; flex-wrap:wrap; gap:4px; max-height:none !important; overflow:visible !important; background:#fff; border:0; padding:4px; border-radius:6px; white-space:normal; } .turbine-list .turbine-pill{ border:1px solid #000; border-radius:4px; padding:2px 6px; white-space:nowrap; font-size:12px; line-height:1.4; }
@media (min-width: 900px){
  .turbine-list{ columns: 3; }
}
@media (min-width: 1200px){
  .turbine-list{ columns: 4; }
}
.turbine-list.expanded{ max-height: none; }

/* تأكيد أن الخلايا لا تفرض عدم التفاف */
.table-wrap td, .table-wrap th{ white-space: normal; min-width: 0; }

</style>
<style>

/* AI fix: prevent horizontal scroll in turbines inside cells */
.table-wrap td *, .table-wrap td{ overflow-x: hidden; }




/* === AI injection: clear grid borders for tables === */
:root{
  --grid:#e5e7eb;       /* خطوط خفيفة وواضحة */
  --grid-strong:#d1d5db;/* خط أقوى للعنوان */
}

/* غلاف الجدول مع إطار داخلي بدون مضاعفة الحدود */
.table-wrap{
  box-shadow: inset 0 0 0 1px var(--grid);
  border-radius: 12px;
  overflow: auto;
  background: var(--card, #fff);
}

/* تخطيط الجدول نفسه */
.table-wrap table{
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
}

/* حدود واضحة بين الخلايا */
.table-wrap th, .table-wrap td{
  border: 1px solid var(--grid);
  background: inherit;
}

/* خط سفلي أوضح للترويسة */
.table-wrap thead th{
  border-bottom: 2px solid var(--grid-strong);
}

/* إزالة ازدواج الحدود على الحواف الخارجية */
.table-wrap tr > *:first-child{ border-inline-start-width: 0; }
.table-wrap tr > *:last-child{  border-inline-end-width: 0; }
.table-wrap thead tr:first-child > *{ border-block-start-width: 0; }
.table-wrap tbody tr:last-child  > *{ border-block-end-width: 0; }

/* تفاعل بسيط عند المرور */
.table-wrap tbody tr:hover{ background:#f9fafb; }



/* === AI override: stronger black borders === */
:root{
  --grid:#000;          /* أسود صريح */
  --grid-strong:#000;   /* أسود صريح */
}
.table-wrap{
  /* إطار داخلي أكثر وضوحًا */
  box-shadow: inset 0 0 0 2px #000;
}
.table-wrap th, .table-wrap td{
  border-color:#000 !important;
  border-width:1px !important;
}
.table-wrap thead th{
  border-bottom-width:2px !important;
  border-bottom-color:#000 !important;
}



/* === AI override: hide mapping fields + checkbox row === */
/* hide the 4 mapping selects for each file box */
.file-box .grid{ display:none !important; }
/* hide the labels containing the specific checkboxes (modern :has()) */
label.inline:has(#chk-normalize),
label.inline:has(#chk-compare-time),
label.inline:has(#chk-status-filter){
  display:none !important;
}
</style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <!-- شعار الشركة بجانب عنوان الصفحة -->
      <div style="display:flex;align-items:center;gap:8px">
        <img src="data:image/jpeg;base64,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" alt="Ras Ghareb Wind Energy S.A.E." style="height:40px; width:auto;">
        <h1>مقارنة إنذارات التوربينات (CSV)</h1>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="lang-switch">
          <button type="button" class="btn soft" data-lang="ar">عربي</button>
          <button type="button" class="btn soft" data-lang="en">English</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap stack">
      <section class="card">
        <div id="intro-text">ارفع ملف <b>اليوم</b> وملف <b>الأمس</b> ثم اضغط <b>قارن الآن</b>. المقارنة الأساسية حسب <span class="badger">التوربينة + كود/حدث الإنذار</span>.</div>
        <div id="console"></div>
      </section>

      <section class="grid">
        <div class="card file-box">
          <b>ملف اليوم</b>
          <input id="file-today" type="file" accept=".csv,text/csv,.txt" />
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px">
            <div class="field"><label>عمود التوربينة</label><select id="col-device-today"></select></div>
            <div class="field"><label>عمود كود/حدث الإنذار</label><select id="col-alarm-today"></select></div>
            <div class="field"><label>الوصف (اختياري)</label><select id="col-desc-today"></select></div>
            <div class="field"><label>وقت التفعيل (اختياري)</label><select id="col-time-today"></select></div>
          </div>
          <div id="meta-today" class="note"></div>
        </div>

        <div class="card file-box">
          <b>ملف الأمس</b>
          <input id="file-yesterday" type="file" accept=".csv,text/csv,.txt" />
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px">
            <div class="field"><label>عمود التوربينة</label><select id="col-device-yesterday"></select></div>
            <div class="field"><label>عمود كود/حدث الإنذار</label><select id="col-alarm-yesterday"></select></div>
            <div class="field"><label>الوصف (اختياري)</label><select id="col-desc-yesterday"></select></div>
            <div class="field"><label>وقت التفعيل (اختياري)</label><select id="col-time-yesterday"></select></div>
          </div>
          <div id="meta-yesterday" class="note"></div>
        </div>

        <!-- ملف أول أمس (اختياري) -->
        <div class="card file-box">
          <b>ملف أول أمس (اختياري)</b>
          <input id="file-daybefore" type="file" accept=".csv,text/csv,.txt" />
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px">
            <div class="field"><label>عمود التوربينة</label><select id="col-device-daybefore"></select></div>
            <div class="field"><label>عمود كود/حدث الإنذار</label><select id="col-alarm-daybefore"></select></div>
            <div class="field"><label>الوصف (اختياري)</label><select id="col-desc-daybefore"></select></div>
            <div class="field"><label>وقت التفعيل (اختياري)</label><select id="col-time-daybefore"></select></div>
          </div>
          <div id="meta-daybefore" class="note"></div>
        </div>
      </section>

      <section class="card">
        <div class="inline">
          <label class="inline"><input id="chk-normalize" type="checkbox" checked />&nbsp;توحيد القيم (Trim/Upper)</label>
          <label class="inline"><input id="chk-compare-time" type="checkbox" />&nbsp;اعتبار وقت التفعيل ضمن المفتاح</label>
          <label class="inline"><input id="chk-status-filter" type="checkbox" />&nbsp;تصفية للسجلات النشطة فقط (STATUS)</label>
        </div>
        <div class="controls">
          <button id="btn-compare" class="btn primary" disabled>قارن الآن</button>
          <button id="btn-reset" class="btn soft">تفريغ الحقول</button>
          <input id="global-search" class="search" type="search" placeholder="ابحث داخل النتائج…" />
        </div>
      </section>

      <section id="summary" class="card" style="display:none">
        <b>ملخص المقارنة</b>
        <div class="summary" style="margin-top:8px">
          <div class="kpi"><div class="label">إجمالي إنذارات اليوم</div><div id="stat-total-today" class="value">–</div></div>
          <div class="kpi"><div class="label">إجمالي إنذارات الأمس</div><div id="stat-total-yesterday" class="value">–</div></div>
          <div class="kpi"><div class="label">إنذارات مكرّرة</div><div id="stat-repeated" class="value">–</div></div>
          <div class="kpi"><div class="label">إنذارات جديدة اليوم</div><div id="stat-new" class="value">–</div></div>
          <div class="kpi"><div class="label">إجمالي إنذارات أول أمس</div><div id="stat-total-daybefore" class="value">–</div></div>
          <div class="kpi"><div class="label">إنذارات مكرّرة خلال ٣ أيام</div><div id="stat-repeated-3days" class="value">–</div></div>
        </div>
      </section>

      <section id="results" class="stack" style="display:none">
        <!-- تنويه عند رفع ملف أول أمس: التوربينات باللون الأحمر تكررت عبر الأيام الثلاثة -->
        <div id="note-3days" class="note" style="display:none; margin-bottom: 8px;"></div>
        <div class="card">
          <div class="inline" style="justify-content:space-between">
            <b>١) إنذارات مكرّرة</b>
            <div class="inline" style="gap:6px">
              <button data-export="repeated" class="btn soft">تنزيل CSV</button>
              <button data-export-image="repeated" class="btn soft">حفظ كصورة</button>
            </div>
          </div>
          <div class="table-wrap"><table id="tbl-repeated">
            <thead><tr>
              <th data-sort="alarm">كود/حدث الإنذار</th>
              <th>وصف</th>
              <th data-sort="devices">التوربينات</th>
            </tr></thead>
            <tbody></tbody>
          </table></div>
        </div>

        <div class="card">
          <div class="inline" style="justify-content:space-between">
            <b>٢) إنذارات جديدة اليوم</b>
            <div class="inline" style="gap:6px">
              <button data-export="new" class="btn soft">تنزيل CSV</button>
              <button data-export-image="new" class="btn soft">حفظ كصورة</button>
            </div>
          </div>
          <div class="table-wrap"><table id="tbl-new">
            <thead><tr>
              <th data-sort="alarm">كود/حدث الإنذار</th>
              <th>وصف</th>
              <th data-sort="devices">التوربينات</th>
            </tr></thead>
            <tbody></tbody>
          </table></div>
        </div>

        <div class="card">
          <div class="inline" style="justify-content:space-between">
            <b>٣) إنذارات اختفت اليوم</b>
            <div class="inline" style="gap:6px">
              <button data-export="cleared" class="btn soft">تنزيل CSV</button>
              <button data-export-image="cleared" class="btn soft">حفظ كصورة</button>
            </div>
          </div>
          <div class="table-wrap"><table id="tbl-cleared">
            <thead><tr>
              <th data-sort="alarm">كود/حدث الإنذار</th>
              <th>وصف</th>
              <th data-sort="devices">التوربينات</th>
            </tr></thead>
            <tbody></tbody>
          </table></div>
        </div>

        <!-- إنذارات مكرّرة خلال ٣ أيام -->
        <div class="card" id="card-repeated-3days" style="display:none">
          <div class="inline" style="justify-content:space-between">
            <b>٤) إنذارات مكرّرة خلال ٣ أيام</b>
            <button data-export="repeated3" class="btn soft">تنزيل CSV</button>
          </div>
          <div class="table-wrap"><table id="tbl-repeated-3days">
            <thead><tr>
              <th data-sort="alarm">كود/حدث الإنذار</th>
              <th>وصف</th>
              <th data-sort="devices">التوربينات</th>
            </tr></thead>
            <tbody></tbody>
          </table></div>
        </div>
      </section>

      <section class="card">
        <b>ملاحظات</b>
        <ul class="note">
          <li>إذا لم تتعرف الأداة على الأعمدة، اخترها يدويًا من القوائم.</li>
          <li>تعمل محليًا بالكامل بدون أي مكتبات خارجية.</li>
        </ul>
      </section>
    </div>
  </main>

  <script>
    // ====== أدوات عامة ======
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const consoleBox = $('#console');
    function showErr(msg, err){ consoleBox.style.display='block'; consoleBox.textContent = msg+(err?(' — '+(err.message||err)):''); console.error(msg, err); }
    function clearErr(){ consoleBox.style.display='none'; consoleBox.textContent=''; }

    function normalizeValue(v){ return v==null ? '' : String(v).trim().toUpperCase(); }

    function detectDelimiter(sample){
      const sc=(sample.match(/;/g)||[]).length, cm=(sample.match(/,/g)||[]).length;
      return sc>cm?';':',';
    }

    // Simple CSV parser supporting quoted fields and delimiter ; or ,
    function parseCSV(text, delimiter){
      delimiter = delimiter || detectDelimiter(text.slice(0,2000));
      // Normalize newlines
      text = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
      // Remove BOM if present
      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
      const rows = [];
      let i=0, field='', row=[], inQuotes=false;
      const pushField = () => { row.push(field); field=''; };
      const pushRow = () => { rows.push(row); row=[]; };
      while(i<text.length){
        const ch = text[i];
        if (inQuotes){
          if (ch === '"'){
            // check escaped double quote
            if (text[i+1] === '"'){ field += '"'; i+=2; continue; }
            inQuotes = false; i++; continue;
          } else {
            field += ch; i++; continue;
          }
        } else {
          if (ch === '"'){ inQuotes = true; i++; continue; }
          if (ch === delimiter){ pushField(); i++; continue; }
          if (ch === '\n'){ pushField(); pushRow(); i++; continue; }
          field += ch; i++; continue;
        }
      }
      // last field/row
      pushField(); if (row.length>1 || (row.length===1 && row[0]!=='')) pushRow();
      // header + data
      const headers = rows.shift() || [];
      const data = rows.map(r => {
        const o = {};
        headers.forEach((h,idx) => { o[h] = r[idx]===undefined? '' : r[idx]; });
        return o;
      });
      return { headers, data, delimiter };
    }

    async function readFileSmart(file){
      // Try multiple encodings using TextDecoder
      const buf = await file.arrayBuffer();
      const tryList = ['utf-8','windows-1252','iso-8859-1'];
      for (const enc of tryList){
        try{
          const txt = new TextDecoder(enc, {fatal:false}).decode(new Uint8Array(buf));
          if (txt && txt.length) return txt;
        }catch(e){}
      }
      return new TextDecoder().decode(new Uint8Array(buf));
    }

    function fillSelectOptions(sel, cols, preferred){
      sel.innerHTML = '<option value=\"\">— غير محدد —</option>';
      cols.forEach(c => {
        const o=document.createElement('option'); o.value=c; o.textContent=c;
        if (preferred && preferred===c) o.selected=true;
        sel.appendChild(o);
      });
    }

    function autoMapColumns(cols){
      const low = cols.map(c=>c.toLowerCase());
      const find=(arr)=>{
        for(const cand of arr){
          const i = low.findIndex(h => h===cand || h.includes(cand));
          if(i!==-1) return cols[i];
        } return '';
      };
      return {
        device: find(['device','wtg','turbine','turbine id','turbine_id','unit']),
        alarm:  find(['id event','id_event','alarm','alarm id','alarm_id','event id','event']),
        desc:   find(['description','message','text']),
        time:   find(['activated','timestamp','time','date']),
        status: find(['status','state'])
      };
    }

    function enableCompareIfReady(){
      $('#btn-compare').disabled = !(state.today.rows.length && state.yesterday.rows.length);
    }

    function downloadCsv(name, rows){
      if(!rows.length) return;
      // تعديل ليناسب التصدير للبيانات المجمعة
      const cols = Object.keys(rows[0]); 
      const csv = [cols.join(',')].concat(rows.map(r=>cols.map(c=>{
        // عند تصدير قائمة التوربينات، استبدل فواصل الأسطر بفاصلة عادية
        let v = r[c]==null? '' : String(r[c]);
        if (c === 'devices') {
          v = v.replace(/\n/g, ', '); // استبدال فواصل الأسطر بفاصلة ومسافة
        }
        return /[\",\n]/.test(v) ? '\"'+v.replace(/\"/g,'\"\"')+'\"' : v;
      }).join(','))).join('\n'); // استخدم \n هنا بدلاً من \\n
      const blob = new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);
    }
    
    // تعديل دالة العرض لتنسيق قائمة التوربينات
    function renderTable(tbody, rows, cols, search='', sort=null){
      let list = rows;
      if(search){
        const q=search.trim().toUpperCase();
        list = rows.filter(r=>Object.values(r).some(v=>String(v??'').toUpperCase().includes(q)));
      }
      if(sort){
        const {key,dir} = sort;
        list = list.slice().sort((a,b)=>{
          const va=String(a[key]??''); const vb=String(b[key]??'');
          return dir==='asc'? va.localeCompare(vb,'ar') : vb.localeCompare(va,'ar');
        });
      }
      tbody.innerHTML = list.map(r=>{
        const cells = cols.map(c=>{
          const val = r[c] ?? '';
          if (c === 'devices') {
            const deviceArr = String(val).split(', ').filter(Boolean);
            const pills = deviceArr.map(dev => {
              // Highlight the pill if this device+alarm pair appears across all three days
              const key = dev + '||' + r.alarm;
              const highlightDev = repeated3Pairs && repeated3Pairs.has(key);
              const pillClass = highlightDev ? 'highlight-3days' : '';
              return `<span class="turbine-pill ${pillClass}">${dev}</span>`;
            }).join('');
            return `<td><div class="turbine-list">${pills}</div></td>`;
          }
          return `<td>${val}</td>`;
        }).join('');
        // Row-level highlighting is not used; individual pills handle highlighting.
        return `<tr>${cells}</tr>`;
      }).join('');
      return list.length;
    }

    // ====== الحالة ======
    let state = {
      today:{file:null, rows:[], cols:[]},
      yesterday:{file:null, rows:[], cols:[]},
      daybefore:{file:null, rows:[], cols:[]}, // أول أمس (اختياري)
      results:{repeated:[], news:[], cleared:[], repeated3:[]},
      sort:{repeated:null, news:null, cleared:null, repeated3:null},
    };

    // Set containing alarm codes that appear on all three days.
    // Updated in compareNow() and used for optional row‑level highlighting.
    let repeated3Set = new Set();

    // Set containing specific device||alarm pairs that appear on all three days.
    // Used to highlight individual turbine pills in the repeated table.
    let repeated3Pairs = new Set();

    // ====== تحميل الملفات ======
    async function handleFile(which, file){
      clearErr();
      try{
        const txt = await readFileSmart(file);
        const delimiter = detectDelimiter(txt.slice(0,2000));
        let parsed = parseCSV(txt, delimiter);
        // لو طلع عمود واحد بس وفي النص فاصل آخر، جرّب الفاصل الآخر
        if (parsed.headers.length<=1 && (txt.includes(';')||txt.includes(','))){
          const alt = delimiter===';'? ',':'('; // bug intentionally? No, fix: should be ',' not '('
        }
      }catch(e){ showErr('تعذّر قراءة الملف. تأكد أنه CSV قياسي.', e); throw e; }
    }

  </script>

  <script>
    // The previous script was interrupted; finalize parsing + UI binding here safely.
    const fileToday = document.getElementById('file-today');
    const fileYesterday = document.getElementById('file-yesterday');
    const fileDayBefore = document.getElementById('file-daybefore');

    async function processFile(which, file){
      clearErr();
      try{
        const txt = await readFileSmart(file);
        let delimiter = detectDelimiter(txt.slice(0,2000));
        let parsed = parseCSV(txt, delimiter);
        if (parsed.headers.length <= 1 && (txt.includes(';') || txt.includes(','))){
          delimiter = (delimiter === ';') ? ',' : ';';
          parsed = parseCSV(txt, delimiter);
        }
        const rows = parsed.data.filter(r => Object.values(r).some(v => v!==null && v!=='') );
        const cols = parsed.headers;

        state[which] = { file, rows, cols };

        const auto = autoMapColumns(cols);
        const prefix =
          which === 'today'     ? '-today' :
          which === 'yesterday' ? '-yesterday' :
                                 '-daybefore';
        fillSelectOptions(document.querySelector('#col-device'+prefix), cols, auto.device);
        fillSelectOptions(document.querySelector('#col-alarm'+prefix),  cols, auto.alarm);
        fillSelectOptions(document.querySelector('#col-desc'+prefix),   cols, auto.desc);
        fillSelectOptions(document.querySelector('#col-time'+prefix),   cols, auto.time);

        const metaEl =
          which === 'today'     ? document.getElementById('meta-today') :
          which === 'yesterday' ? document.getElementById('meta-yesterday') :
                                  document.getElementById('meta-daybefore');
        metaEl.innerHTML = `✅ تمت القراءة: <b>${rows.length.toLocaleString()}</b> صف — أعمدة: <code>${cols.join(', ')}</code> — فاصل: <code>${delimiter}</code>`;

        enableCompareIfReady();
      }catch(e){ showErr('تعذّر تحليل الملف.'); }
    }

    fileToday.addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0];
      if (f) processFile('today', f);
    });
    fileYesterday.addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0];
      if (f) processFile('yesterday', f);
    });

    // Listener for the optional day-before file
    fileDayBefore.addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0];
      if (f) processFile('daybefore', f);
    });

    function getSelected(which){
      const prefix =
        which === 'today'     ? '-today' :
        which === 'yesterday' ? '-yesterday' :
                                '-daybefore';
      return {
        device: document.querySelector('#col-device'+prefix).value,
        alarm:  document.querySelector('#col-alarm'+prefix).value,
        desc:   document.querySelector('#col-desc'+prefix).value,
        time:   document.querySelector('#col-time'+prefix).value,
      };
    }

    function buildKey(row, cols, includeTime, normalize){
      const d = row[cols.device], a = row[cols.alarm];
      if (d==null || a==null) return '';
      const dev = normalize? normalizeValue(d) : String(d).trim();
      const alc = normalize? normalizeValue(a) : String(a).trim();
      let key = dev+'||'+alc;
      if (includeTime && cols.time && row[cols.time]){
        const t = normalize? normalizeValue(row[cols.time]) : String(row[cols.time]).trim();
        key += '||'+t;
      }
      return key;
    }

    function indexBy(rows, cols, includeTime, normalize){
      const m = new Map();
      for (const r of rows){
        const k = buildKey(r, cols, includeTime, normalize);
        if (!k) continue;
        const obj = m.get(k) || { count:0, row:r };
        obj.count += 1; m.set(k, obj);
      }
      return m;
    }

        // تم نقل دالة تجميع النتائج إلى الـ Worker (Back-End).



        async function compareNow(){
      clearErr();

      const includeTime = document.getElementById('chk-compare-time').checked;
      const normalize   = document.getElementById('chk-normalize').checked;
      const statusOnly  = document.getElementById('chk-status-filter').checked;

      const selT = getSelected('today');
      const selY = getSelected('yesterday');
      const selD = getSelected('daybefore');

      if (!selT.device || !selT.alarm || !selY.device || !selY.alarm){
        showErr('اختر أعمدة التوربينة وكود/حدث الإنذار أولًا.');
        return;
      }

      const hasDayBefore = state.daybefore.rows && state.daybefore.rows.length > 0;
      if (hasDayBefore){
        if (!selD.device) selD.device = selY.device;
        if (!selD.alarm)  selD.alarm  = selY.alarm;
        if (!selD.desc)   selD.desc   = selY.desc;
        if (!selD.time)   selD.time   = selY.time;
      }

      const btn = document.getElementById('btn-compare');
      const oldLabel = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'جاري المقارنة…';

      try{
        const payload = {
          type: 'compareAlarms',
          includeTime: includeTime,
          normalize: normalize,
          statusOnly: statusOnly,
          today: {
            rows: state.today.rows,
            mapping: selT
          },
          yesterday: {
            rows: state.yesterday.rows,
            mapping: selY
          },
          daybefore: {
            rows: state.daybefore.rows,
            mapping: selD
          }
        };

        const res = await fetch('https://rgwe-api.mohamedlasheen2019.workers.dev/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok){
          throw new Error('API HTTP '+res.status);
        }

        const data = await res.json();
        if (!data.ok){
          throw new Error(data.error || 'API returned not-ok');
        }

        // تحديث النتائج في الحالة
        state.results = data.results || {repeated:[], news:[], cleared:[], repeated3:[]};

        // تحديث مجموعة الأزواج المكررة عبر ٣ أيام للتظليل في الجداول
        if (Array.isArray(data.repeated3Pairs)){
          repeated3Pairs = new Set(data.repeated3Pairs);
        } else {
          repeated3Pairs = new Set();
        }

        // تلخيص الأرقام
        const summary = data.summary || {};
        const totalTodayEl     = document.getElementById('stat-total-today');
        const totalYesterdayEl = document.getElementById('stat-total-yesterday');
        const totalDBEl        = document.getElementById('stat-total-daybefore');
        const statRepEl        = document.getElementById('stat-repeated');
        const statNewEl        = document.getElementById('stat-new');
        const stat3El          = document.getElementById('stat-repeated-3days');

        if (totalTodayEl){
          const v = summary.totalToday != null ? summary.totalToday : (state.today.rows || []).length;
          totalTodayEl.textContent = Number(v).toLocaleString();
        }
        if (totalYesterdayEl){
          const v = summary.totalYesterday != null ? summary.totalYesterday : (state.yesterday.rows || []).length;
          totalYesterdayEl.textContent = Number(v).toLocaleString();
        }
        if (totalDBEl){
          let v;
          if (summary.totalDaybefore != null){
            v = summary.totalDaybefore;
          }else if (hasDayBefore){
            v = (state.daybefore.rows || []).length;
          }else{
            v = null;
          }
          totalDBEl.textContent = (v==null) ? '–' : Number(v).toLocaleString();
        }
        if (statRepEl){
          const v = summary.repeated != null ? summary.repeated : (state.results.repeated || []).length;
          statRepEl.textContent = Number(v).toLocaleString();
        }
        if (statNewEl){
          const v = summary.news != null ? summary.news : (state.results.news || []).length;
          statNewEl.textContent = Number(v).toLocaleString();
        }
        if (stat3El){
          let v;
          if (summary.repeated3 != null){
            v = summary.repeated3;
          }else{
            v = (state.results.repeated3 || []).length;
          }
          stat3El.textContent = hasDayBefore && v!=null ? Number(v).toLocaleString() : '–';
        }

        // إظهار/إخفاء كارد ٣ أيام والملاحظة
        const card3 = document.getElementById('card-repeated-3days');
        if (card3){
          const hasR3 = state.results.repeated3 && state.results.repeated3.length;
          card3.style.display = (hasDayBefore && hasR3) ? '' : 'none';
        }

        const noteEl = document.getElementById('note-3days');
        if (noteEl){
          const hasR3 = state.results.repeated3 && state.results.repeated3.length;
          if (hasDayBefore && hasR3){
            noteEl.style.display = '';
            noteEl.textContent = 'التوربينات المظللة باللون الأحمر هي تلك التي تكرّر نفس الإنذار في ملفات الأيام الثلاثة.';
          }else{
            noteEl.style.display = 'none';
            noteEl.textContent = '';
          }
        }

        document.getElementById('summary').style.display = '';
        document.getElementById('results').style.display = '';

        renderAllTables();
        clearErr();
      }catch(e){
        showErr('حدث خطأ أثناء الاتصال بخدمة المقارنة.', e);
      }finally{
        btn.disabled = false;
        btn.textContent = oldLabel || 'قارن الآن';
      }
    }

function renderAllTables(){
      const q = document.getElementById('global-search').value;
      
      // --- تعديل: أسماء الأعمدة الجديدة ---
      const repCols  = ['alarm','description','devices'];
      const newCols  = ['alarm','description','devices'];
      const clrCols  = ['alarm','description','devices'];
      const rep3Cols = ['alarm','description','devices'];

      const repN  = renderTable(document.querySelector('#tbl-repeated tbody'), state.results.repeated,  repCols, q, state.sort.repeated);
      const newN  = renderTable(document.querySelector('#tbl-new tbody'),      state.results.news,      newCols, q, state.sort.news);
      const clrN  = renderTable(document.querySelector('#tbl-cleared tbody'),  state.results.cleared,   clrCols, q, state.sort.cleared);
      const rep3N = document.querySelector('#tbl-repeated-3days tbody')
                    ? renderTable(document.querySelector('#tbl-repeated-3days tbody'), state.results.repeated3, rep3Cols, q, state.sort.repeated3)
                    : 0;

      if (!repN)  document.querySelector('#tbl-repeated tbody').innerHTML       = '<tr><td colspan="3" class="muted">لا توجد نتائج</td></tr>';
      if (!newN)  document.querySelector('#tbl-new tbody').innerHTML            = '<tr><td colspan="3" class="muted">لا توجد نتائج</td></tr>';
      if (!clrN)  document.querySelector('#tbl-cleared tbody').innerHTML        = '<tr><td colspan="3" class="muted">لا توجد نتائج</td></tr>';
      if (document.querySelector('#tbl-repeated-3days tbody') && !rep3N){
        document.querySelector('#tbl-repeated-3days tbody').innerHTML = '<tr><td colspan="3" class="muted">لا توجد نتائج</td></tr>';
      }
    }

    function makeSortable(tableId, keyMap, sortKey){
      $$(tableId + ' thead th').forEach(th=>{
        const k = th.getAttribute('data-sort'); if(!k) return;
        th.addEventListener('click', ()=>{
          const curr = state.sort[sortKey];
          const key = keyMap[k];
          const dir = (!curr || curr.key!==key) ? 'asc' : (curr.dir==='asc'?'desc':'asc');
          state.sort[sortKey] = { key, dir };
          renderAllTables();
        });
      });
    }

    document.getElementById('btn-compare').addEventListener('click', compareNow);
    document.getElementById('btn-reset').addEventListener('click', ()=>location.reload());
    document.getElementById('global-search').addEventListener('input', renderAllTables);

    // --- تعديل: مفاتيح الترتيب الجديدة ---
    makeSortable('#tbl-repeated', {alarm:'alarm', devices:'devices'}, 'repeated');
    makeSortable('#tbl-new', {alarm:'alarm', devices:'devices'}, 'news');
    makeSortable('#tbl-cleared', {alarm:'alarm', devices:'devices'}, 'cleared');
    makeSortable('#tbl-repeated-3days', {alarm:'alarm', devices:'devices'}, 'repeated3');
    // --- نهاية التعديل ---

    // تفعيل أزرار التصدير
    $$('button[data-export]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const key = e.target.getAttribute('data-export');
        if (state.results[key] && state.results[key].length > 0) {
          downloadCsv(`export_${key}.csv`, state.results[key]);
        }
      });
    });

    // Enable compare once both chosen
    function checkEnable(){ enableCompareIfReady(); }
    document.getElementById('file-today').addEventListener('change', checkEnable);
    document.getElementById('file-yesterday').addEventListener('change', checkEnable);

    // Prevent drag-drop on whole page from opening file
    window.addEventListener('dragover', e=>e.preventDefault());
    window.addEventListener('drop', e=>e.preventDefault());
  </script>

  <!-- Override turbine pill highlight after all other CSS definitions.
       This ensures that turbines repeated across all three days have a bold
       red background, white text, and red border. Without this extra rule,
       earlier definitions of .turbine-pill may override the highlight color. -->
  <style>
  /* override highlight colour for repeated alarms across three days in the interactive tables */
  .turbine-list .turbine-pill.highlight-3days {
    /* very light red background so the card stands out without being harsh */
    background-color: #ffd9d9 !important;
    /* always draw a solid black border like other turbine cards */
    border-color: #000 !important;
    /* black text for readability */
    color: #000 !important;
  }
  </style>

  <!-- تكبير حجم خط الجداول ليكون أوضح وأسهل في القراءة -->
  <style>
    .table-wrap th, .table-wrap td {
      font-size: 16px;
    }
    .turbine-list .turbine-pill {
      font-size: 15px;
    }
  </style>

<script>
document.addEventListener('DOMContentLoaded', function(){
  // hide mapping grids
  document.querySelectorAll('.file-box .grid').forEach(el=> el.style.display='none');
  // hide the checkbox row container
  ['#chk-normalize','#chk-compare-time','#chk-status-filter'].forEach(sel=>{
    const input = document.querySelector(sel);
    if(input){
      const label = input.closest('label.inline');
      if(label){ label.style.display = 'none'; }
    }
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  Array.from(document.querySelectorAll('b')).forEach(function(el){
    if (el.textContent && el.textContent.trim() === 'ملاحظات'){
      // اخف العنوان
      el.style.display = 'none';
      // اخف القائمة التالية إذا كانت ملاحظات
      const next = el.nextElementSibling;
      if (next && next.matches('ul.note')){
        next.style.display = 'none';
      }
    }
  });
});
</script>

<!-- Injected: PDF Export Helpers -->
<script>
(function(){
  // Add PDF buttons next to CSV buttons on DOM ready
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('button[data-export]').forEach(function(csvBtn){
      var key = csvBtn.getAttribute('data-export');
      if(!key) return;
      var parent = csvBtn.parentElement || csvBtn.closest('div');
      if(!parent) parent = csvBtn;
      var exists = parent.querySelector('button[data-export-pdf="'+key+'"]');
      if(!exists){
        var spacer = document.createTextNode(' ');
        var pdfBtn = document.createElement('button');
        pdfBtn.className = csvBtn.className || 'btn soft';
        pdfBtn.setAttribute('data-export-pdf', key);
        pdfBtn.textContent = 'تصدير PDF';
        if (csvBtn.nextSibling) {
          parent.insertBefore(spacer, csvBtn.nextSibling);
          parent.insertBefore(pdfBtn, spacer.nextSibling);
        } else {
          parent.appendChild(spacer);
          parent.appendChild(pdfBtn);
        }
      }
    // زر تقرير كامل PDF أعلى أول كارد
    var firstCard = document.querySelector('.card');
    if(firstCard && !document.getElementById('btn-export-full-pdf')){
      var wrap = document.createElement('div');
      wrap.className = 'inline';
      wrap.style.justifyContent = 'flex-end';
      wrap.style.margin = '8px 0';
      var btn = document.createElement('button');
      btn.id = 'btn-export-full-pdf';
      btn.className = 'btn';
      btn.textContent = 'تقرير كامل PDF';
      btn.addEventListener('click', exportFullReportPDF);
      wrap.appendChild(btn);
      firstCard.parentNode.insertBefore(wrap, firstCard);
    }

    });

    // Wire up listeners
    document.querySelectorAll('button[data-export-pdf]').forEach(function(btn){
      btn.addEventListener('click', function(e){
        var key = e.currentTarget.getAttribute('data-export-pdf');
        exportTablePDF(key, e.currentTarget);
      });
    });
  });

  // تحميل مكتبة html2canvas من CDN عند الطلب. إذا لم تتوفر الشبكة، قد لا تعمل خاصية التصدير كصورة.
  (function(){
    var script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
    script.defer = true;
    document.head.appendChild(script);
  })();

  // بعد تحميل الصفحة، حضر أزرار تصدير الصور واكتب الدالة المساعدة
  document.addEventListener('DOMContentLoaded', function(){
    const tableMap = {
      'repeated': 'tbl-repeated',
      'new':      'tbl-new',
      'cleared':  'tbl-cleared',
      'repeated3': 'tbl-repeated-3days'
    };
    async function exportTableAsImage(tableId, filename) {
      const tableEl = document.getElementById(tableId);
      if (!tableEl) return;
      // حدد العنصر المستهدف لالتقاط الصورة: نلتقط الغلاف حول الجدول ليشمل الإطار بالكامل
      const target = tableEl.closest('.table-wrap') || tableEl;
      // انتظر تحميل html2canvas
      if (typeof html2canvas === 'undefined') {
        alert('تعذّر العثور على html2canvas. يرجى التأكد من الاتصال بالإنترنت.');
        return;
      }
      try {
        // capture the target element; set a transparent background so the image blends well on white
        const canvas = await html2canvas(target, {backgroundColor: null, scale: 2});
        const dataURL = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = dataURL;
        a.download = filename || 'table.png';
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch(e) {
        console.error('Error exporting table:', e);
        alert('حدث خطأ أثناء تصدير الجدول كصورة.');
      }
    }
    document.querySelectorAll('button[data-export-image]').forEach(btn => {
      btn.addEventListener('click', function(){
        const key = btn.getAttribute('data-export-image');
        const tableId = tableMap[key];
        if (tableId) {
          exportTableAsImage(tableId, `export_${key}.png`);
        }
      });
    });
  });

  function buildPrintHTML(opts){
    opts = opts || {};
    const title = opts.title || 'تصدير جدول';
    const bodyHTML = opts.bodyHTML || '';
    const landscape = !!opts.landscape;
    const pageSize = landscape ? 'A4 landscape' : 'A4';

    return `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>${escapeHtml(title)}</title>
<style>
  @page { size:${pageSize}; margin:12mm }
  html,body{ height:100%; }
  body{
    font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans Arabic","Noto Kufi Arabic",Arial;
    color:#000;
  }
  h1{ font-size:18px; margin:0 0 6px; }
  small{ color:#555; display:block; margin-bottom:10px; }

  table{
    width:100%;
    border-collapse:collapse;
    table-layout:fixed;
    font-size:12px;
    line-height:1.4;
  }
  thead th{
    border:1px solid #000;
    border-bottom-width:2px;
    background:#fff;
    font-weight:600;
    vertical-align:top;
    text-align:right;
    padding:4px 6px;
  }
  td{
    border:1px solid #000;
    padding:4px 6px;
    vertical-align:top;
    text-align:right;
    word-wrap:break-word;
  }

  /* توزيع الأعمدة:
     1) كود/حدث الإنذار (يمين) صغير
     2) وصف              أوسع
     3) التوربينات       بادجات ملتفة
  */
  table th:first-child,
  table td:first-child{
    width:10%;
    white-space:nowrap;
  }
  table th:nth-child(2),
  table td:nth-child(2){
    width:55%;
  }
  table th:nth-child(3),
  table td:nth-child(3){
    width:35%;
  }

  tr{ page-break-inside:avoid; }
  thead{ display:table-header-group; }
  tfoot{ display:table-footer-group; }

  .turbine-list{
    display:flex;
    flex-wrap:wrap;
    column-gap:4px;
    row-gap:4px;
    max-height:none !important;
    overflow:visible !important;
    background:#fff;
    border:0;
    padding:4px;
    border-radius:6px;
  }
  .turbine-list .turbine-pill{
    display:inline-block;
    border:1px solid #000;
    border-radius:4px;
    padding:2px 6px;
    white-space:nowrap;
    font-size:11px;
    line-height:1.4;
  }

  /* highlight style for turbines repeated across three days in the print export
     Use a very light red background with a solid black border and black text */
  .turbine-list .turbine-pill.highlight-3days{
    background-color:#ffd9d9;
    border-color:#000;
    color:#000;
  }

  .page-break{ page-break-before:always; }
  @media print { .no-print{ display:none !important; } }
</style>
</head>
<body>
  <h1>${escapeHtml(title)}</h1>
  <small>تاريخ التوليد: ${new Date().toLocaleString('ar-EG')}</small>
  ${bodyHTML}
  <script>window.onafterprint=function(){window.close()};window.print();<\/script>

<footer style="position:fixed;left:0;bottom:0;width:100%;background:#fff;margin-top:24px;padding:8px 0;text-align:center;font-size:12px;color:#777;border-top:1px solid #eee;">
  Designed by Mohamed Lasheen
</footer>

</body>
</html>`;
}

function cloneTableForPrint(tableEl){
    var clone = tableEl.cloneNode(true);
    clone.removeAttribute('style');
    clone.querySelectorAll('[style]').forEach(function(e){ e.removeAttribute('style'); });
    clone.querySelectorAll('.turbine-list').forEach(function(el){ el.classList.add('turbine-list'); });
    return clone;
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, function(m){
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
    });
  }

  function exportTablePDF(key, triggerBtn){
    var map = {
      'repeated':  { id: 'tbl-repeated',        title: '١) إنذارات مكرّرة' },
      'new':       { id: 'tbl-new',             title: '٢) إنذارات جديدة اليوم' },
      'cleared':   { id: 'tbl-cleared',         title: '٣) إنذارات اختفت اليوم' },
      'repeated3': { id: 'tbl-repeated-3days',  title: '٤) إنذارات مكرّرة خلال ٣ أيام' }
    };
    var info = map[key] || null;
    var table = null;
    if(info && info.id){
      table = document.getElementById(info.id);
    }
    // Fallback: infer table from DOM near the button
    if(!table && triggerBtn){
      var container = triggerBtn.closest('.card') || triggerBtn.closest('section') || triggerBtn.closest('div');
      if(container){
        table = container.querySelector('table');
      }
      if(!info){
        var heading = (container && (container.querySelector('b, h1, h2, h3, .title'))) || null;
        var titleText = heading ? heading.textContent.trim() : (key || 'جدول');
        info = { title: titleText };
      }
    }
    if(!table){ alert('تعذّر العثور على الجدول المطلوب.'); return; }

    var landscape = (table.scrollWidth || table.offsetWidth || 0) > 1000;
    var clean = cloneTableForPrint(table);
    var html = buildPrintHTML({ title: (info && info.title) || 'تصدير جدول', bodyHTML: clean.outerHTML, landscape: landscape });

    var win = window.open('', '_blank');
    win.document.write(html);
    win.document.close();
  }

  // بناء HTML للطباعة المجمعة (كل الجداول)
  function buildFullReportPrintHTML(title, bodyHTML){
    const pageSize = 'A4 landscape';
    return `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>${title}</title>
<style>
  @page { size:${pageSize}; margin:12mm }
  html,body{ height:100%; }
  body{
    font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans Arabic","Noto Kufi Arabic",Arial;
    color:#000;
  }
  h1{ font-size:18px; margin:0 0 6px; }
  small{ color:#555; display:block; margin-bottom:10px; }

  table{
    width:100%;
    border-collapse:collapse;
    table-layout:fixed;
    font-size:12px;
    line-height:1.4;
  }
  thead th{
    border:1px solid #000;
    border-bottom-width:2px;
    background:#fff;
    font-weight:600;
    vertical-align:top;
    text-align:right;
    padding:4px 6px;
  }
  td{
    border:1px solid #000;
    padding:4px 6px;
    vertical-align:top;
    text-align:right;
    word-wrap:break-word;
  }

  /* توزيع الأعمدة الحقيقي: 
     1) كود/حدث الإنذار  (يمين)  صغير
     2) وصف                أوسع
     3) التوربينات         أعمدة بادجات
  */
  table th:first-child, table td:first-child{ width:10%; white-space:nowrap; }
  table th:nth-child(2), table td:nth-child(2){ width:55%; }
  table th:nth-child(3), table td:nth-child(3){ width:35%; }

  tr{ page-break-inside:avoid; }
  thead{ display:table-header-group; }
  tfoot{ display:table-footer-group; }

  .turbine-list{
    display:flex;
    flex-wrap:wrap;
    column-gap:4px;
    row-gap:4px;
    max-height:none !important;
    overflow:visible !important;
    background:#fff;
    border:0;
    padding:4px;
    border-radius:6px;
  }
  .turbine-list .turbine-pill{
    display:inline-block;
    border:1px solid #000;
    border-radius:4px;
    padding:2px 6px;
    white-space:nowrap;
    font-size:11px;
    line-height:1.4;
  }

  .page-break{ page-break-before:always; }
  @media print { .no-print{ display:none !important; } }
</style>
</head>
<body>
  <small>تاريخ التوليد: ${new Date().toLocaleString('ar-EG')}</small>
  ${bodyHTML}
  <script>window.onafterprint=function(){window.close()};window.print();<\/script>

<footer style="position:fixed;left:0;bottom:0;width:100%;background:#fff;margin-top:24px;padding:8px 0;text-align:center;font-size:12px;color:#777;border-top:1px solid #eee;">
  Designed by Mohamed Lasheen
</footer>

</body>
</html>`;
}

// إنشاء التقرير الكامل (التلات جداول مع بعض)
  function exportFullReportPDF(){
    var sections = [
      { id:'tbl-repeated',       title:'١) إنذارات مكرّرة' },
      { id:'tbl-new',            title:'٢) إنذارات جديدة اليوم' },
      { id:'tbl-cleared',        title:'٣) إنذارات اختفت اليوم' },
      { id:'tbl-repeated-3days', title:'٤) إنذارات مكرّرة خلال ٣ أيام' }
    ];
    var htmlParts = [];
    sections.forEach(function(s, idx){
      var el = document.getElementById(s.id);
      if(!el) return;
      var hasRows = el.querySelector('tbody tr');
      if(!hasRows) return;
      var clone = el.cloneNode(true);
      clone.removeAttribute('style');
      clone.querySelectorAll('[style]').forEach(function(e){ e.removeAttribute('style'); });
      var pageBreak = idx ? '<div class="page-break"></div>' : '';
      htmlParts.push(pageBreak + '<h1>'+s.title+'</h1>' + clone.outerHTML);
    });
    if(!htmlParts.length){ alert('لا يوجد محتوى للتصدير.'); return; }

    var finalHTML = buildFullReportPrintHTML('تقرير مقارنة الإنذارات', htmlParts.join(''));
    var win = window.open('', '_blank');
    win.document.write(finalHTML);
    win.document.close();
  }
})();
</script>


<script>
(function(){
  var uiTexts = {
    ar: {
      pageTitle: 'مقارنة إنذارات التوربينات (CSV) — نسخة مُجمّعة',
      headerTitle: 'مقارنة إنذارات التوربينات (CSV)',
      headerSub: 'نسخة تعمل محليًا بالكامل',
      intro:
        'ارفع ملف <b>اليوم</b> وملف <b>الأمس</b> ثم اضغط <b>قارن الآن</b>. المقارنة الأساسية حسب <span class="badger">التوربينة + كود/حدث الإنذار</span>.',
      fileToday: 'ملف اليوم',
      fileYesterday: 'ملف الأمس',
      fileDaybefore: 'ملف أول أمس (اختياري)',
      colDevice: 'عمود التوربينة',
      colAlarm: 'عمود كود/حدث الإنذار',
      colDesc: 'الوصف (اختياري)',
      colTime: 'وقت التفعيل (اختياري)',
      btnCompare: 'قارن الآن',
      btnReset: 'تفريغ الحقول',
      searchPlaceholder: 'ابحث داخل النتائج…',
      summaryTitle: 'ملخص المقارنة',
      kpiTotalToday: 'إجمالي إنذارات اليوم',
      kpiTotalYesterday: 'إجمالي إنذارات الأمس',
      kpiRepeated: 'إنذارات مكرّرة',
      kpiNewToday: 'إنذارات جديدة اليوم',
      kpiTotalDaybefore: 'إجمالي إنذارات أول أمس',
      kpiRepeated3: 'إنذارات مكرّرة خلال ٣ أيام',
      cardRepeatedTitle: '١) إنذارات مكرّرة',
      cardNewTitle: '٢) إنذارات جديدة اليوم',
      cardClearedTitle: '٣) إنذارات اختفت اليوم',
      cardRepeated3Title: '٤) إنذارات مكرّرة خلال ٣ أيام',
      btnDownloadCsv: 'تنزيل CSV',
      btnSaveImage: 'حفظ كصورة',
      btnExportPdf: 'تصدير PDF',
      btnExportFullPdf: 'تقرير كامل PDF',
      noResults: 'لا توجد نتائج',
      tableAlarmHeader: 'كود/حدث الإنذار',
      tableDescHeader: 'وصف',
      tableDevicesHeader: 'التوربينات',
      note3days: 'التوربينات المظللة باللون الأحمر هي تلك التي تكرّر نفس الإنذار في ملفات الأيام الثلاثة.',
      errorParseFile: 'تعذّر تحليل الملف.',
      errorSelectCols: 'اختر أعمدة التوربينة وكود/حدث الإنذار أولًا.',
      errorReadFile: 'تعذّر قراءة الملف. تأكد أنه CSV قياسي.'
    },
    en: {
      pageTitle: 'Turbine Alarm Comparison (CSV) — Aggregated view',
      headerTitle: 'Turbine Alarm Comparison (CSV)',
      headerSub: 'Fully offline local version',
      intro:
        'Upload the <b>Today</b> file and the <b>Yesterday</b> file, then click <b>Compare now</b>. The main comparison key is <span class="badger">Turbine + Alarm code/event</span>.',
      fileToday: 'Today file',
      fileYesterday: 'Yesterday file',
      fileDaybefore: 'Day-before file (optional)',
      colDevice: 'Turbine column',
      colAlarm: 'Alarm code / event column',
      colDesc: 'Description (optional)',
      colTime: 'Activation time (optional)',
      btnCompare: 'Compare now',
      btnReset: 'Clear inputs',
      searchPlaceholder: 'Search in results…',
      summaryTitle: 'Comparison summary',
      kpiTotalToday: 'Total alarms today',
      kpiTotalYesterday: 'Total alarms yesterday',
      kpiRepeated: 'Repeated alarms',
      kpiNewToday: 'New alarms today',
      kpiTotalDaybefore: 'Total alarms day before',
      kpiRepeated3: 'Alarms repeated across 3 days',
      cardRepeatedTitle: '1) Repeated alarms',
      cardNewTitle: '2) New alarms today',
      cardClearedTitle: '3) Alarms cleared today',
      cardRepeated3Title: '4) Alarms repeated over 3 days',
      btnDownloadCsv: 'Download CSV',
      btnSaveImage: 'Save as image',
      btnExportPdf: 'Export PDF',
      btnExportFullPdf: 'Full report PDF',
      noResults: 'No results',
      tableAlarmHeader: 'Alarm code / event',
      tableDescHeader: 'Description',
      tableDevicesHeader: 'Turbines',
      note3days: 'Turbines highlighted in light red are those that repeat the same alarm in all three day files.',
      errorParseFile: 'Failed to parse file.',
      errorSelectCols: 'Please select the turbine and alarm columns first.',
      errorReadFile: 'Failed to read file. Make sure it is a standard CSV.'
    }
  };

  var currentLang = 'ar';

  function applyStaticTexts(lang){
    var t = uiTexts[lang] || uiTexts.ar;

    document.documentElement.lang = lang;
    document.documentElement.dir  = (lang === 'ar') ? 'rtl' : 'ltr';
    document.body.classList.toggle('ltr', lang === 'en');

    document.title = t.pageTitle;

    var hTitle = document.querySelector('header h1');
    if (hTitle) hTitle.textContent = t.headerTitle;

    var hSub = document.querySelector('header .muted');
    if (hSub) hSub.textContent = t.headerSub;

    var intro = document.getElementById('intro-text');
    if (intro) intro.innerHTML = t.intro;

    var fileTitles = document.querySelectorAll('.file-box > b');
    if (fileTitles[0]) fileTitles[0].textContent = t.fileToday;
    if (fileTitles[1]) fileTitles[1].textContent = t.fileYesterday;
    if (fileTitles[2]) fileTitles[2].textContent = t.fileDaybefore;

    ['col-device-today','col-device-yesterday','col-device-daybefore'].forEach(function(id){
      var sel = document.getElementById(id);
      if (!sel) return;
      var label = sel.closest('.field').querySelector('label');
      if (label) label.textContent = t.colDevice;
    });
    ['col-alarm-today','col-alarm-yesterday','col-alarm-daybefore'].forEach(function(id){
      var sel = document.getElementById(id);
      if (!sel) return;
      var label = sel.closest('.field').querySelector('label');
      if (label) label.textContent = t.colAlarm;
    });
    ['col-desc-today','col-desc-yesterday','col-desc-daybefore'].forEach(function(id){
      var sel = document.getElementById(id);
      if (!sel) return;
      var label = sel.closest('.field').querySelector('label');
      if (label) label.textContent = t.colDesc;
    });
    ['col-time-today','col-time-yesterday','col-time-daybefore'].forEach(function(id){
      var sel = document.getElementById(id);
      if (!sel) return;
      var label = sel.closest('.field').querySelector('label');
      if (label) label.textContent = t.colTime;
    });

    var btnCompare = document.getElementById('btn-compare');
    if (btnCompare) btnCompare.textContent = t.btnCompare;

    var btnReset = document.getElementById('btn-reset');
    if (btnReset) btnReset.textContent = t.btnReset;

    var search = document.getElementById('global-search');
    if (search) search.setAttribute('placeholder', t.searchPlaceholder);

    var sumTitle = document.querySelector('#summary > b');
    if (sumTitle) sumTitle.textContent = t.summaryTitle;

    var kLabels = document.querySelectorAll('#summary .kpi .label');
    if (kLabels[0]) kLabels[0].textContent = t.kpiTotalToday;
    if (kLabels[1]) kLabels[1].textContent = t.kpiTotalYesterday;
    if (kLabels[2]) kLabels[2].textContent = t.kpiRepeated;
    if (kLabels[3]) kLabels[3].textContent = t.kpiNewToday;
    if (kLabels[4]) kLabels[4].textContent = t.kpiTotalDaybefore;
    if (kLabels[5]) kLabels[5].textContent = t.kpiRepeated3;

    var resultCards = document.querySelectorAll('#results .card');
    if (resultCards[0]) {
      var b0 = resultCards[0].querySelector('b');
      if (b0) b0.textContent = t.cardRepeatedTitle;
    }
    if (resultCards[1]) {
      var b1 = resultCards[1].querySelector('b');
      if (b1) b1.textContent = t.cardNewTitle;
    }
    if (resultCards[2]) {
      var b2 = resultCards[2].querySelector('b');
      if (b2) b2.textContent = t.cardClearedTitle;
    }
    if (resultCards[3]) {
      var b3 = resultCards[3].querySelector('b');
      if (b3) b3.textContent = t.cardRepeated3Title;
    }

    document.querySelectorAll('button[data-export]').forEach(function(btn){
      btn.textContent = t.btnDownloadCsv;
    });
    document.querySelectorAll('button[data-export-image]').forEach(function(btn){
      btn.textContent = t.btnSaveImage;
    });
    document.querySelectorAll('button[data-export-pdf]').forEach(function(btn){
      btn.textContent = t.btnExportPdf;
    });
    var fullBtn = document.getElementById('btn-export-full-pdf');
    if (fullBtn) fullBtn.textContent = t.btnExportFullPdf;

    ['tbl-repeated','tbl-new','tbl-cleared','tbl-repeated-3days'].forEach(function(id){
      var tbl = document.getElementById(id);
      if (!tbl) return;
      var ths = tbl.querySelectorAll('thead th');
      if (ths[0]) ths[0].textContent = t.tableAlarmHeader;
      if (ths[1]) ths[1].textContent = t.tableDescHeader;
      if (ths[2]) ths[2].textContent = t.tableDevicesHeader;
    });

    updateNote3Days();
  }

  function patchNoResultsRows(){
    var t = uiTexts[currentLang] || uiTexts.ar;
    ['tbl-repeated','tbl-new','tbl-cleared','tbl-repeated-3days'].forEach(function(id){
      var tbody = document.querySelector('#' + id + ' tbody');
      if (!tbody) return;
      var td = tbody.querySelector('td.muted');
      if (td) td.textContent = t.noResults;
    });
  }

  function updateNote3Days(){
    var note = document.getElementById('note-3days');
    if (!note) return;
    if (note.style.display === 'none') return;
    var t = uiTexts[currentLang] || uiTexts.ar;
    if (note.textContent && note.textContent.trim()) {
      note.textContent = t.note3days;
    }
  }

  function setLang(lang){
    currentLang = (lang === 'en') ? 'en' : 'ar';

    var btns = document.querySelectorAll('.lang-switch [data-lang]');
    btns.forEach(function(btn){
      btn.classList.remove('primary');
      btn.classList.add('soft');
      if (btn.getAttribute('data-lang') === currentLang){
        btn.classList.remove('soft');
        btn.classList.add('primary');
      }
    });

    applyStaticTexts(currentLang);
    patchNoResultsRows();

    if (window.localStorage){
      try { localStorage.setItem('alarms-ui-lang', currentLang); } catch(e){}
    }
  }

  window.getAlarmUiLang = function(){ return currentLang; };
  window.setAlarmUiLang = setLang;

  if (window.showErr){
    var originalShowErr = window.showErr;
    window.showErr = function(msg, err){
      var t = uiTexts[currentLang] || uiTexts.ar;
      if (msg === 'تعذّر تحليل الملف.')      msg = t.errorParseFile;
      if (msg === 'اختر أعمدة التوربينة وكود/حدث الإنذار أولًا.') msg = t.errorSelectCols;
      if (msg === 'تعذّر قراءة الملف. تأكد أنه CSV قياسي.')       msg = t.errorReadFile;
      return originalShowErr(msg, err);
    };
  }

  document.addEventListener('DOMContentLoaded', function(){
    var btns = document.querySelectorAll('.lang-switch [data-lang]');
    btns.forEach(function(btn){
      btn.addEventListener('click', function(){
        setLang(btn.getAttribute('data-lang'));
      });
    });

    var saved = 'ar';
    if (window.localStorage){
      try {
        var stored = localStorage.getItem('alarms-ui-lang');
        if (stored === 'en' || stored === 'ar') saved = stored;
      } catch(e){}
    }
    setLang(saved);

    var compareBtn = document.getElementById('btn-compare');
    if (compareBtn){
      compareBtn.addEventListener('click', function(){
        setTimeout(function(){
          patchNoResultsRows();
          updateNote3Days();
        }, 0);
      });
    }

    var searchInput = document.getElementById('global-search');
    if (searchInput){
      searchInput.addEventListener('input', function(){
        setTimeout(patchNoResultsRows, 0);
      });
    }
  });
})();
</script>


<footer style="position:fixed;left:0;bottom:0;width:100%;background:#fff;margin-top:24px;padding:8px 0;text-align:center;font-size:12px;color:#777;border-top:1px solid #eee;">
  Designed by Mohamed Lasheen
</footer>

</body>
</html>